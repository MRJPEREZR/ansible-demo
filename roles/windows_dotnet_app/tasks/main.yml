---
- name: Check installed .NET runtimes
  win_shell: dotnet --list-runtimes
  register: dotnet_runtimes
  ignore_errors: yes

- name: Set flag if .NET 8 runtime is installed
  set_fact:
    dotnet8_installed: "{{ 'Microsoft.NETCore.App 8.0' in dotnet_runtimes.stdout }}"

- name: Download .NET 8 runtime installer if missing
  win_get_url:
    url: https://dotnet.microsoft.com/download/dotnet/thank-you/runtime-8.0.0-windows-x64-installer
    dest: C:\Temp\dotnet-runtime-8.0.exe
  when: not dotnet8_installed

- name: Install .NET 8 runtime silently
  win_shell: C:\Temp\dotnet-runtime-8.0.exe /quiet /norestart
  args:
    creates: 'C:\Program Files\dotnet\shared\Microsoft.NETCore.App\8.0.0'
  when: not dotnet8_installed

- name: Remove installer
  win_file:
    path: C:\Temp\dotnet-runtime-8.0.exe
    state: absent
  when: not dotnet8_installed

- name: Verify .NET runtime installed
  win_shell: dotnet --list-runtimes
  register: dotnet_runtimes_after

- name: Ensure IIS is installed
  win_feature:
    name: Web-Server
    state: present

- name: Ensure temp folder exists
  win_file:
    path: C:\Temp
    state: directory

- name: Download DemoApp.zip
  win_get_url:
    url: "https://storageaccountvmdemo1.blob.core.windows.net/blobdemo/DemoApp.zip?se=2026-12-31T23%3A59%3A00Z&sp=r&sv=2022-11-02&sr=b&sig=b4oTGPXaQdMNjfgwgiQvpg%2FcLAgcoiiLKd8sGZIsIrc%3D"
    dest: "C:\\Temp\\DemoApp.zip"
  register: download_result

- name: Check if download was successful
  win_stat:
    path: C:\Temp\DemoApp.zip
  register: zip_file

- name: Fail if download failed
  fail:
    msg: "Failed to download DemoApp.zip"
  when: not zip_file.stat.exists

- name: Unzip DemoApp.zip
  win_unzip:
    src: C:\Temp\DemoApp.zip
    dest: C:\Temp\DemoApp
    removes: C:\Temp\DemoApp

- name: Copy published files
  win_copy:
    src: C:\Temp\DemoApp\publish\
    dest: C:\inetpub\wwwroot\DemoApp
    remote_src: yes
    removes: C:\inetpub\wwwroot\DemoApp

- name: Create a new IIS website for DemoApp
  win_iis_website:
    name: DemoAppSite
    state: started
    physical_path: C:\inetpub\wwwroot\DemoApp
    port: 8080

- name: Open port 8080 in Windows Firewall
  win_firewall_rule:
    name: "Allow HTTP Port 8080"
    enable: yes
    localport: 8080
    protocol: TCP
    action: allow
    direction: in

- name: Verify website is running
  win_wait_for:
    host: localhost
    port: 8080
    state: started
    delay: 10
    timeout: 60
  register: website_check

- name: Restart IIS
  win_shell: iisreset

- name: Display success message
  debug:
    msg: "DemoApp successfully deployed and running on http://localhost:8080"